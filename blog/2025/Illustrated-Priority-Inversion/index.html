<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Illustrated Priority Inversion | Sean Kim </title> <meta name="author" content="Sean Kim"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://seanshnkim.github.io/blog/2025/Illustrated-Priority-Inversion/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Sean</span> Kim </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/post/index.html">post </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Illustrated Priority Inversion</h1> <p class="post-meta"> Created in February 11, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/priority"> <i class="fa-solid fa-hashtag fa-sm"></i> priority</a>   <a href="/blog/tag/inversion"> <i class="fa-solid fa-hashtag fa-sm"></i> inversion</a>   ·   <a href="/blog/category/rtos"> <i class="fa-solid fa-tag fa-sm"></i> RTOS</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="what-is-priority-inversion">What is Priority Inversion?</h2> <p>The definition of priority inversion is well-explained in Wikipedia:</p> <blockquote> <p>High priority task is indirectly preempted by a low (or medium) priority task.</p> </blockquote> <p>This should not happen because it is literally a “high priority” task which indicates that it should be executed before all the other lower priority tasks. In other words, priority inversion is a problematic situation and we have to prevent it.</p> <p>I will first demonstrate the concept with analogy and then with a simple program in C. Lastly, I will discuss solutions to priority inverison.</p> <h2 id="real-world-analogy-of-priority-inversion">Real-world Analogy of Priority Inversion</h2> <p>Assume there are three different tasks:</p> <ul> <li>High priority task (i.e. “HP Task”)</li> <li>Medium priority task (i.e. “MP Task”)</li> <li>Low priority task (i.e. “LP Task”)</li> </ul> <p>If there is no problem with a scheduler then HP Task should always be executed first, MP Task next, and at last LP Task.</p> <p>But then there is a “critical section”. Critical section is a part of a program or hardware that accesses a shared resource. Only one process (task) is allowed to access the critical section at one time. <a href="https://en.wikipedia.org/wiki/Critical_section" rel="external nofollow noopener" target="_blank">Wikipedia: Critical Section</a></p> <p>In this example, three different characters represent each task:</p> <ul> <li>HP Task = “Harry”</li> <li>MP Task = “Mary”</li> <li>LP Task = “Larry”</li> </ul> <h3 id="prerequisites">Prerequisites</h3> <p>Before walking through the example, there are some prerequisites to keep in mind:</p> <ol> <li>Only one person can stay in the house. This is because the processor core cannot accept more than one task.</li> </ol> <p>![[single_thread1.png]]</p> <ol> <li>Once a person starts using a pot, it cannot be interrupted or taken by other person until he is done with using it (even if the highest priority task requests using it!)</li> </ol> <p>![[critical_section1.png]]</p> <h3 id="1-lp-task-starts-first">1. LP Task starts first</h3> <p>Let’s start with Larry. Larry came home in the first place and decided to prepare breakfast for tomorrow. He uses a pot (critical section) in the kitchen. This is the only pot in the kitchen, so unless he is finished no one else can use it. We would assume that making breakfast for tomorrow is not urget, so it is a low priority task.</p> <p>![[d1.png]]</p> <p>![[d2.png]]</p> <h3 id="2-hp-task-tries-to-preempt-lp-task">2. HP Task “tries to” preempt LP Task</h3> <p>While Larry is cooking her food, Harry comes home (Remember, Harry cannot enter home right away. He would have to wait in front of the door).</p> <p>![[d3.png]]</p> <h3 id="3-hp-task-is-blocked">3. HP Task is blocked</h3> <p>Because Harry needs to eat lunch before the class, and he was going to make pasta. (Pasta needs a pot to boil it) Harry shouts to the kitchen, “I need to cook!” Obviously Harry’s task has higher priority, but he cannot take away Larry’s pot. That’s why Harry has to wait in front of the house, not being able to start cooking (“<strong>blocked</strong>” state).</p> <p>![[d4.png]]</p> <h3 id="4-mp-task-preempts-lp-task">4. MP Task preempts LP Task</h3> <p>Afterwards, Mary comes in. Mary came home to clean the house, because she has a guest coming in the evening. This task priority is higher than cooking for tomorrow, but less than Harry’s. But because she is not using the pot, and because her task has higher priority than Larry’s she enters home and kicks out Larry.</p> <p>![[d5.png]]</p> <p>![[d6.png]]</p> <p>Now, Harry is frustrated. His task was the most urgent one, but turns out that Mary is now in the house instead!</p> <p>![[task_table.png]]</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/_posts/attachments/d6-480.webp 480w,/_posts/attachments/d6-800.webp 800w,/_posts/attachments/d6-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/_posts/attachments/d6.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/_posts/attachments/7-480.webp 480w,/_posts/attachments/7-800.webp 800w,/_posts/attachments/7-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/_posts/attachments/7.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> A simple, elegant caption looks good between image rows. </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/_posts/attachments/8-480.webp 480w,/_posts/attachments/8-800.webp 800w,/_posts/attachments/8-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/_posts/attachments/8.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/_posts/attachments/10-480.webp 480w,/_posts/attachments/10-800.webp 800w,/_posts/attachments/10-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/_posts/attachments/10.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="why-does-priority-inversion-matter-in-rtos">Why does priority inversion matter in RTOS?</h2> <p>In RTOS, it is crucial to schedule tasks so that they have a certain limit of deadline. The priority of each task must be carried out in order.</p> <h2 id="demo">Demo</h2> <p>Here is source code that can be run in STM32F4xx device:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"freertos/FreeRTOS.h"</span><span class="cp">
#include</span> <span class="cpf">"freertos/task.h"</span><span class="cp">
#include</span> <span class="cpf">"freertos/semphr.h"</span><span class="cp">
</span>
<span class="n">SemaphoreHandle_t</span> <span class="n">mutex</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">lowPriorityTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
        <span class="c1">// Simulate work</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
        <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mediumPriorityTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Simulate work</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">3000</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">highPriorityTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
        <span class="c1">// Critical section</span>
        <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">app_main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="n">xSemaphoreCreateMutex</span><span class="p">();</span>
    <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">lowPriorityTask</span><span class="p">,</span> <span class="s">"Low"</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">mediumPriorityTask</span><span class="p">,</span> <span class="s">"Medium"</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">highPriorityTask</span><span class="p">,</span> <span class="s">"High"</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>In the next post, I will discuss several solutions for priority inversion.</p> <h2 id="references">References</h2> <ul> <li>https://en.wikipedia.org/wiki/Priority_inversion</li> <li>https://www.embedded.com/how-to-use-priority-inheritance/</li> <li>https://www.foxipex.com/2024/11/08/priority-inversion-and-priority-inheritance-in-freertos/</li> <li>https://www.highintegritysystems.com/downloads/RTOS_Tutorials/Priority_Inversion.pdf</li> <li>https://www.freertos.org/Documentation/02-Kernel/02-Kernel-features/02-Queues-mutexes-and-semaphores/04-Mutexes</li> <li>https://www.geeksforgeeks.org/difference-between-priority-inversion-and-priority-inheritance/</li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/photo-gallery/">a post with image galleries</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Sean Kim. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>