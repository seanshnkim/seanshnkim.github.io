<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://seanshnkim.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://seanshnkim.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2025-02-11T17:35:25+00:00</updated><id>https://seanshnkim.github.io/feed.xml</id><title type="html">blank</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">Illustrated priority inversion</title><link href="https://seanshnkim.github.io/blog/2025/Illustrated-Priority-Inversion/" rel="alternate" type="text/html" title="Illustrated priority inversion"/><published>2025-02-11T00:00:00+00:00</published><updated>2025-02-11T00:00:00+00:00</updated><id>https://seanshnkim.github.io/blog/2025/Illustrated%20Priority%20Inversion</id><content type="html" xml:base="https://seanshnkim.github.io/blog/2025/Illustrated-Priority-Inversion/"><![CDATA[<h2 id="what-is-priority-inversion">What is Priority Inversion?</h2> <p>The definition of priority inversion is well-explained in Wikipedia:</p> <blockquote> <p>High priority task is indirectly preempted by a low (or medium) priority task.</p> </blockquote> <p>This should not happen because it is literally a “high priority” task which indicates that it should be executed before all the other lower priority tasks. In other words, priority inversion is a problematic situation and we have to prevent it.</p> <p>I will first demonstrate the concept with analogy and then with a simple program in C. Lastly, I will discuss solutions to priority inverison.</p> <h2 id="real-world-analogy-of-priority-inversion">Real-world Analogy of Priority Inversion</h2> <p>Assume there are three different tasks:</p> <ul> <li>High priority task (i.e. “HP Task”)</li> <li>Medium priority task (i.e. “MP Task”)</li> <li>Low priority task (i.e. “LP Task”)</li> </ul> <p>If there is no problem with a scheduler then HP Task should always be executed first, MP Task next, and at last LP Task.</p> <p>But then there is a “critical section”. Critical section is a part of a program or hardware that accesses a shared resource. Only one process (task) is allowed to access the critical section at one time. <a href="https://en.wikipedia.org/wiki/Critical_section">Wikipedia: Critical Section</a></p> <p>In this example, three different characters represent each task:</p> <ul> <li>HP Task = “Harry”</li> <li>MP Task = “Mary”</li> <li>LP Task = “Larry”</li> </ul> <h3 id="prerequisites">Prerequisites</h3> <p>Before walking through the example, there are some prerequisites to keep in mind:</p> <ol> <li>Only one person can stay in the house. This is because the processor core cannot accept more than one task.</li> </ol> <p>![[single_thread1.png]]</p> <ol> <li>Once a person starts using a pot, it cannot be interrupted or taken by other person until he is done with using it (even if the highest priority task requests using it!)</li> </ol> <p>![[critical_section1.png]]</p> <h3 id="1-lp-task-starts-first">1. LP Task starts first</h3> <p>Let’s start with Larry. Larry came home in the first place and decided to prepare breakfast for tomorrow. He uses a pot (critical section) in the kitchen. This is the only pot in the kitchen, so unless he is finished no one else can use it. We would assume that making breakfast for tomorrow is not urget, so it is a low priority task.</p> <p>![[d1.png]]</p> <p>![[d2.png]]</p> <h3 id="2-hp-task-tries-to-preempt-lp-task">2. HP Task “tries to” preempt LP Task</h3> <p>While Larry is cooking her food, Harry comes home (Remember, Harry cannot enter home right away. He would have to wait in front of the door).</p> <p>![[d3.png]]</p> <h3 id="3-hp-task-is-blocked">3. HP Task is blocked</h3> <p>Because Harry needs to eat lunch before the class, and he was going to make pasta. (Pasta needs a pot to boil it) Harry shouts to the kitchen, “I need to cook!” Obviously Harry’s task has higher priority, but he cannot take away Larry’s pot. That’s why Harry has to wait in front of the house, not being able to start cooking (“<strong>blocked</strong>” state).</p> <p>![[d4.png]]</p> <h3 id="4-mp-task-preempts-lp-task">4. MP Task preempts LP Task</h3> <p>Afterwards, Mary comes in. Mary came home to clean the house, because she has a guest coming in the evening. This task priority is higher than cooking for tomorrow, but less than Harry’s. But because she is not using the pot, and because her task has higher priority than Larry’s she enters home and kicks out Larry.</p> <p>![[d5.png]]</p> <p>![[d6.png]]</p> <p>Now, Harry is frustrated. His task was the most urgent one, but turns out that Mary is now in the house instead!</p> <p>![[task_table.png]]</p> <h2 id="why-does-priority-inversion-matter-in-rtos">Why does priority inversion matter in RTOS?</h2> <p>In RTOS, it is crucial to schedule tasks so that they have a certain limit of deadline. The priority of each task must be carried out in order.</p> <h2 id="demo">Demo</h2> <p>Here is source code that can be run in STM32F4xx device:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"freertos/FreeRTOS.h"</span><span class="cp">
#include</span> <span class="cpf">"freertos/task.h"</span><span class="cp">
#include</span> <span class="cpf">"freertos/semphr.h"</span><span class="cp">
</span>
<span class="n">SemaphoreHandle_t</span> <span class="n">mutex</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">lowPriorityTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
        <span class="c1">// Simulate work</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
        <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">1000</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mediumPriorityTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Simulate work</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">3000</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">highPriorityTask</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">pvParameters</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">xSemaphoreTake</span><span class="p">(</span><span class="n">mutex</span><span class="p">,</span> <span class="n">portMAX_DELAY</span><span class="p">);</span>
        <span class="c1">// Critical section</span>
        <span class="n">xSemaphoreGive</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
        <span class="n">vTaskDelay</span><span class="p">(</span><span class="n">pdMS_TO_TICKS</span><span class="p">(</span><span class="mi">5000</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">app_main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">mutex</span> <span class="o">=</span> <span class="n">xSemaphoreCreateMutex</span><span class="p">();</span>
    <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">lowPriorityTask</span><span class="p">,</span> <span class="s">"Low"</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">mediumPriorityTask</span><span class="p">,</span> <span class="s">"Medium"</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">xTaskCreate</span><span class="p">(</span><span class="n">highPriorityTask</span><span class="p">,</span> <span class="s">"High"</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>In the next post, I will discuss several solutions for priority inversion.</p> <h2 id="references">References</h2> <ul> <li>https://en.wikipedia.org/wiki/Priority_inversion</li> <li>https://www.embedded.com/how-to-use-priority-inheritance/</li> <li>https://www.foxipex.com/2024/11/08/priority-inversion-and-priority-inheritance-in-freertos/</li> <li>https://www.highintegritysystems.com/downloads/RTOS_Tutorials/Priority_Inversion.pdf</li> <li>https://www.freertos.org/Documentation/02-Kernel/02-Kernel-features/02-Queues-mutexes-and-semaphores/04-Mutexes</li> <li>https://www.geeksforgeeks.org/difference-between-priority-inversion-and-priority-inheritance/</li> </ul>]]></content><author><name></name></author><summary type="html"><![CDATA[What is Priority Inversion?]]></summary></entry><entry><title type="html">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</title><link href="https://seanshnkim.github.io/blog/2024/google-gemini-updates-flash-15-gemma-2-and-project-astra/" rel="alternate" type="text/html" title="Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra"/><published>2024-05-14T00:00:00+00:00</published><updated>2024-05-14T00:00:00+00:00</updated><id>https://seanshnkim.github.io/blog/2024/google-gemini-updates-flash-15-gemma-2-and-project-astra</id><content type="html" xml:base="https://seanshnkim.github.io/blog/2024/google-gemini-updates-flash-15-gemma-2-and-project-astra/"><![CDATA[]]></content><author><name></name></author><summary type="html"><![CDATA[We’re sharing updates across our Gemini family of models and a glimpse of Project Astra, our vision for the future of AI assistants.]]></summary></entry><entry><title type="html">Displaying External Posts on Your al-folio Blog</title><link href="https://seanshnkim.github.io/blog/2022/displaying-external-posts-on-your-al-folio-blog/" rel="alternate" type="text/html" title="Displaying External Posts on Your al-folio Blog"/><published>2022-04-23T23:20:09+00:00</published><updated>2022-04-23T23:20:09+00:00</updated><id>https://seanshnkim.github.io/blog/2022/displaying-external-posts-on-your-al-folio-blog</id><content type="html" xml:base="https://seanshnkim.github.io/blog/2022/displaying-external-posts-on-your-al-folio-blog/"><![CDATA[]]></content><author><name></name></author></entry></feed>